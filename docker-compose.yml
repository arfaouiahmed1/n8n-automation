services:
  n8n:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: n8n-custom
    ports:
      - "${N8N_PORT:-5678}:5678"
    env_file:
      - .env
    environment:
      - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      # Security settings for external modules
      - NODE_FUNCTION_ALLOW_BUILTIN=path,fs,child_process
      - NODE_FUNCTION_ALLOW_EXTERNAL=puppeteer,fingerprint-injector
      - NODE_PATH=/usr/local/lib/node_modules
      # Pointing n8n to the venv python binary
      - N8N_PYTHON_BINARY=/opt/venv/bin/python3
      - N8N_RUNNERS_ENABLED=false
      # Environment variables from .env
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - TZ=${TZ:-Europe/Paris}
    volumes:
      - ./data:/home/node/.n8n
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s